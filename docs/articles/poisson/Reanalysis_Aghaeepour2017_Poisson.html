<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Poisson Log-Normal Model â€¢ cytoeffect</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Poisson Log-Normal Model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">cytoeffect</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/Confounders.html">Confounders and Biases</a>
    </li>
    <li>
      <a href="../../articles/logistic/Reanalysis_Aghaeepour2017.html">Logistic Linear Mixed Effects Model</a>
    </li>
    <li>
      <a href="../../articles/poisson/Reanalysis_Aghaeepour2017_Poisson.html">Poisson Log-Normal Model</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ChristofSeiler/cytoeffect">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Poisson Log-Normal Model</h1>
                        <h4 class="author">Christof Seiler</h4>
            <address class="author_afil">
      Department of Statistics, Stanford University<br><small class="dont-index">Source: <a href="https://github.com/ChristofSeiler/cytoeffect/blob/master/vignettes/poisson/Reanalysis_Aghaeepour2017_Poisson.Rmd"><code>vignettes/poisson/Reanalysis_Aghaeepour2017_Poisson.Rmd</code></a></small>
      <div class="hidden name"><code>Reanalysis_Aghaeepour2017_Poisson.Rmd</code></div>

    </address>
</div>

    
    
<div id="goal" class="section level1">
<h1 class="hasAnchor">
<a href="#goal" class="anchor"></a>Goal</h1>
<p>Reanalysis of mass cytometry data from <span class="citation">Aghaeepour et al. (2017)</span> using the Poisson Log-Normal Model.</p>
</div>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Parse input parameters.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">ncells =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">floor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(params<span class="op">$</span>ncells))</a>
<a class="sourceLine" id="cb1-2" title="2">ncells</a></code></pre></div>
<pre><code>## [1] Inf</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">seed =<span class="st"> </span>params<span class="op">$</span>seed</a>
<a class="sourceLine" id="cb3-2" title="2">seed</a></code></pre></div>
<pre><code>## [1] "0xdada"</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">ncores =<span class="st"> </span><span class="dv">8</span></a></code></pre></div>
<p>Install packages.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">pkgs_needed =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"devtools"</span>,<span class="st">"tidyverse"</span>,<span class="st">"magrittr"</span>,<span class="st">"SummarizedExperiment"</span>,</a>
<a class="sourceLine" id="cb6-2" title="2">                <span class="st">"ggthemes"</span>,<span class="st">"cowplot"</span>,<span class="st">"RColorBrewer"</span>,<span class="st">"broom"</span>,<span class="st">"hexbin"</span>,</a>
<a class="sourceLine" id="cb6-3" title="3">                <span class="st">"intergraph"</span>,<span class="st">"igraph"</span>,<span class="st">"ggnetwork"</span>,<span class="st">"ggcorrplot"</span>,<span class="st">"MASS"</span>,</a>
<a class="sourceLine" id="cb6-4" title="4">                <span class="st">"parallel"</span>,<span class="st">"dplyr"</span>)</a>
<a class="sourceLine" id="cb6-5" title="5">letsinstall =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(pkgs_needed, <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/installed.packages">installed.packages</a></span>())</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(letsinstall) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-7" title="7">  BiocManager<span class="op">::</span><span class="kw">install</span>(letsinstall)</a>
<a class="sourceLine" id="cb6-8" title="8">}</a>
<a class="sourceLine" id="cb6-9" title="9">devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"ChristofSeiler/cytoeffect"</span>)</a></code></pre></div>
<p>Load packages.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"cytoeffect"</span>)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"tidyverse"</span>)</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"magrittr"</span>)</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"SummarizedExperiment"</span>)</a>
<a class="sourceLine" id="cb7-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggthemes"</span>)</a>
<a class="sourceLine" id="cb7-6" title="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"cowplot"</span>)</a>
<a class="sourceLine" id="cb7-7" title="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"RColorBrewer"</span>)</a>
<a class="sourceLine" id="cb7-8" title="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"broom"</span>)</a>
<a class="sourceLine" id="cb7-9" title="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"intergraph"</span>)</a>
<a class="sourceLine" id="cb7-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"igraph"</span>)</a>
<a class="sourceLine" id="cb7-11" title="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggnetwork"</span>)</a>
<a class="sourceLine" id="cb7-12" title="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggcorrplot"</span>)</a>
<a class="sourceLine" id="cb7-13" title="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"MASS"</span>)</a>
<a class="sourceLine" id="cb7-14" title="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"parallel"</span>)</a>
<a class="sourceLine" id="cb7-15" title="15"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"dplyr"</span>)</a>
<a class="sourceLine" id="cb7-16" title="16"><span class="kw">theme_set</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/ggthemes/topics/theme_few">theme_few</a></span>())</a></code></pre></div>
</div>
<div id="load-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-data" class="anchor"></a>Load Data</h1>
<p>Load <code>SummarizedExperiment</code> object from CytoGLMM workflow.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"se_aghaeepour2017immune.Rdata"</span>)</a>
<a class="sourceLine" id="cb8-2" title="2">exprs =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/SummarizedExperiment/topics/SummarizedExperiment-class">assay</a></span>(se_aghaeepour2017immune)</a>
<a class="sourceLine" id="cb8-3" title="3">sample_info =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/SummarizedExperiment/topics/SummarizedExperiment-class">rowData</a></span>(se_aghaeepour2017immune)</a>
<a class="sourceLine" id="cb8-4" title="4">sample_info_names =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(sample_info)</a>
<a class="sourceLine" id="cb8-5" title="5">df_samples =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(exprs), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(sample_info))</a>
<a class="sourceLine" id="cb8-6" title="6">df_samples <span class="op">%&lt;&gt;%</span><span class="st"> </span>as.tibble</a>
<a class="sourceLine" id="cb8-7" title="7">protein_names =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/SummarizedExperiment/topics/SummarizedExperiment-class">colData</a></span>(se_aghaeepour2017immune) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="st">  </span>as.data.frame <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(type <span class="op">==</span><span class="st"> "function"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="st">  </span>.<span class="op">$</span>protein_name</a>
<a class="sourceLine" id="cb8-11" title="11">gate_protein_names =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/SummarizedExperiment/topics/SummarizedExperiment-class">colData</a></span>(se_aghaeepour2017immune) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="st">  </span>as.data.frame <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(type <span class="op">==</span><span class="st"> "phenotype"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="st">  </span>.<span class="op">$</span>protein_name</a></code></pre></div>
</div>
<div id="fit-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fit-model" class="anchor"></a>Fit Model</h1>
<p>Cells count of subsets.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">df_samples <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(term,celltype,donor) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(n)</a></code></pre></div>
<pre><code>## # A tibble: 379 x 4
## # Groups:   term, celltype [24]
##    term          celltype donor       n
##    &lt;fct&gt;         &lt;chr&gt;    &lt;chr&gt;   &lt;int&gt;
##  1 1st trimester intMC    PTLG001     1
##  2 3rd trimester gdT      PTLG018     1
##  3 3rd trimester gdT      PTLG019     1
##  4 3rd trimester gdT      PTLG020     1
##  5 3rd trimester intMC    PTLG009     1
##  6 3rd trimester ncMC     PTLG018     1
##  7 3rd trimester intMC    PTLG018     3
##  8 3rd trimester ncMC     PTLG009     3
##  9 1st trimester gdT      PTLG020     4
## 10 3rd trimester intMC    PTLG004     5
## # ... with 369 more rows</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">df_samples <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(term,celltype,donor) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 379 x 4
## # Groups:   term, celltype [24]
##    term          celltype   donor       n
##    &lt;fct&gt;         &lt;chr&gt;      &lt;chr&gt;   &lt;int&gt;
##  1 1st trimester CD4+Tmem   PTLG009 35076
##  2 3rd trimester CD4+Tmem   PTLG007 34303
##  3 1st trimester CD4+Tmem   PTLG003 30796
##  4 3rd trimester CD4+Tmem   PTLG009 29886
##  5 1st trimester CD4+Tmem   PTLG007 28958
##  6 1st trimester CD4+Tnaive PTLG022 27953
##  7 1st trimester CD4+Tmem   PTLG024 27592
##  8 3rd trimester CD4+Tnaive PTLG005 27318
##  9 3rd trimester CD4+Tnaive PTLG022 25901
## 10 3rd trimester CD4+Tnaive PTLG001 24423
## # ... with 369 more rows</code></pre>
<div id="subsampling" class="section level2">
<h2 class="hasAnchor">
<a href="#subsampling" class="anchor"></a>Subsampling</h2>
<p>Subsample to only one cell type and one donor.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">df_samples_subset =<span class="st"> </span>df_samples <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(celltype <span class="op">==</span><span class="st"> "NK"</span>)</a>
<a class="sourceLine" id="cb13-2" title="2">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(protein_names,gate_protein_names,sample_info_names)</a></code></pre></div>
<p>Count gating proteins.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/se-deprecated.html">mutate_</a></span>(<span class="dt">cell_size =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(gate_protein_names,<span class="dt">collapse =</span> <span class="st">"+"</span>))</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="kw">ggplot</span>(df_samples_subset, <span class="kw">aes</span>(cell_size)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">100</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>term, <span class="dt">ncol =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/count_gating_proteins-1.png" width="700"></p>
<p>Explore possible NK cells heterogeneity as a function of CD16 and CD56 expression levels.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">tfm =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Hyperbolic">asinh</a></span>(x<span class="op">/</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb15-2" title="2">colorscale =<span class="st"> </span><span class="kw">scale_fill_gradientn</span>(</a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="dt">colors =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/RColorBrewer/topics/ColorBrewer">brewer.pal</a></span>(<span class="dv">9</span>, <span class="st">"YlGnBu"</span>)), </a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)))</a>
<a class="sourceLine" id="cb15-5" title="5">)</a>
<a class="sourceLine" id="cb15-6" title="6">gate_nk =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CD16"</span>,<span class="st">"CD56"</span>)</a>
<a class="sourceLine" id="cb15-7" title="7">df_gate_nk =<span class="st"> </span>df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(donor, file_name, term, gate_nk)</a>
<a class="sourceLine" id="cb15-8" title="8">df_gate_nk <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">mutate_at</a></span>(gate_nk, tfm)</a>
<a class="sourceLine" id="cb15-9" title="9"><span class="kw">ggplot</span>(df_gate_nk, <span class="kw">aes</span>(<span class="dt">x =</span> CD16, <span class="dt">y =</span> CD56)) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="st">  </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">16</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>term) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-13" title="13"><span class="st">  </span>colorscale</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/gating_markers-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">ggplot</span>(df_gate_nk, <span class="kw">aes</span>(<span class="dt">x =</span> CD16, <span class="dt">y =</span> CD56)) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="st">  </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">16</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>donor, <span class="dt">ncol =</span> <span class="dv">6</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="st">  </span>colorscale</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/gating_markers-2.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">ggplot</span>(df_gate_nk <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">         </span><span class="kw">gather</span>(protein_name, value, <span class="op">-</span>donor, <span class="op">-</span>file_name, <span class="op">-</span>term), </a>
<a class="sourceLine" id="cb17-3" title="3">       <span class="kw">aes</span>(value, <span class="dt">fill =</span> term)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">30</span>, <span class="dt">alpha=</span> <span class="fl">0.5</span>, <span class="dt">position =</span> <span class="st">"identity"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>protein_name)</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/gating_markers-3.png" width="700"></p>
<p>NK subset analysis.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">CD56_tfm =</span> <span class="kw">tfm</span>(CD56))</a>
<a class="sourceLine" id="cb18-2" title="2">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">CD56_tfm =</span> (CD56_tfm<span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(CD56_tfm))<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(CD56_tfm))</a>
<a class="sourceLine" id="cb18-3" title="3">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">CD16_tfm =</span> <span class="kw">tfm</span>(CD16))</a>
<a class="sourceLine" id="cb18-4" title="4">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">CD16_tfm =</span> (CD16_tfm<span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(CD16_tfm))<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(CD16_tfm))</a>
<a class="sourceLine" id="cb18-5" title="5">tb_fit =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(protein_names, <span class="cf">function</span>(y) {</a>
<a class="sourceLine" id="cb18-6" title="6">  fit =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/glm">glm</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(y, <span class="st">"~ term + CD56_tfm + CD16_tfm"</span>), <span class="dt">data =</span> df_samples_subset)</a>
<a class="sourceLine" id="cb18-7" title="7">  <span class="kw"><a href="https://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(fit) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="st">    </span><span class="kw">add_column</span>(<span class="dt">protein_name =</span> y)</a>
<a class="sourceLine" id="cb18-9" title="9">  }) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</a>
<a class="sourceLine" id="cb18-10" title="10"><span class="kw">ggplot</span>(tb_fit, <span class="co"># %&gt;% dplyr::filter(term != "(Intercept)"),</span></a>
<a class="sourceLine" id="cb18-11" title="11">       <span class="kw">aes</span>(<span class="dt">x =</span> estimate, <span class="dt">y =</span> protein_name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="st">  </span><span class="kw">geom_errorbarh</span>(<span class="kw">aes</span>(<span class="dt">xmax =</span> estimate <span class="op">+</span><span class="st"> </span><span class="fl">1.96</span><span class="op">*</span>std.error, </a>
<a class="sourceLine" id="cb18-15" title="15">                     <span class="dt">xmin =</span> estimate <span class="op">-</span><span class="st"> </span><span class="fl">1.96</span><span class="op">*</span>std.error)) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>term) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggthemes/topics/scale_few">scale_color_few</a></span>()</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/nk_subset_analysis-1.png" width="700"></p>
<p>Subsample cells so that to a maximum number of cells per celltype and donor.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(df_samples_subset) <span class="op">&gt;</span><span class="st"> </span>ncells) {</a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(seed)</a>
<a class="sourceLine" id="cb19-3" title="3">  <span class="co"># subsample depending on max cell count</span></a>
<a class="sourceLine" id="cb19-4" title="4">  df_count =<span class="st"> </span>df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(donor) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/tally.html">tally</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nnew =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(n <span class="op">&gt;</span><span class="st"> </span>ncells,ncells,n))</a>
<a class="sourceLine" id="cb19-6" title="6">  <span class="co"># create table with a data frame in one column</span></a>
<a class="sourceLine" id="cb19-7" title="7">  df_nested =<span class="st"> </span>df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(donor) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(df_count,<span class="dt">by =</span> <span class="st">"donor"</span>)</a>
<a class="sourceLine" id="cb19-9" title="9">  <span class="co"># subsample per donor</span></a>
<a class="sourceLine" id="cb19-10" title="10">  df_samples_subset =<span class="st"> </span>df_nested <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">samp =</span> <span class="kw">map2</span>(data, nnew, sample_n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(donor, samp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="st">    </span><span class="kw">unnest</span>()</a>
<a class="sourceLine" id="cb19-14" title="14">}</a></code></pre></div>
<p>Subset cells count.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(term,celltype,donor) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(n)</a></code></pre></div>
<pre><code>## # A tibble: 32 x 4
## # Groups:   term, celltype [2]
##    term          celltype donor       n
##    &lt;fct&gt;         &lt;chr&gt;    &lt;chr&gt;   &lt;int&gt;
##  1 3rd trimester NK       PTLG024  2380
##  2 3rd trimester NK       PTLG001  3125
##  3 3rd trimester NK       PTLG020  3230
##  4 1st trimester NK       PTLG020  3412
##  5 1st trimester NK       PTLG001  3474
##  6 3rd trimester NK       PTLG009  3764
##  7 1st trimester NK       PTLG018  4083
##  8 1st trimester NK       PTLG024  4100
##  9 1st trimester NK       PTLG010  4273
## 10 3rd trimester NK       PTLG019  4542
## # ... with 22 more rows</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(term,celltype,donor) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 32 x 4
## # Groups:   term, celltype [2]
##    term          celltype donor       n
##    &lt;fct&gt;         &lt;chr&gt;    &lt;chr&gt;   &lt;int&gt;
##  1 1st trimester NK       PTLG008 13395
##  2 1st trimester NK       PTLG022  8222
##  3 1st trimester NK       PTLG003  8087
##  4 3rd trimester NK       PTLG008  7953
##  5 3rd trimester NK       PTLG018  7620
##  6 1st trimester NK       PTLG029  7211
##  7 1st trimester NK       PTLG019  6671
##  8 1st trimester NK       PTLG012  6624
##  9 3rd trimester NK       PTLG004  6501
## 10 3rd trimester NK       PTLG002  6120
## # ... with 22 more rows</code></pre>
</div>
<div id="hmc-sampling" class="section level2">
<h2 class="hasAnchor">
<a href="#hmc-sampling" class="anchor"></a>HMC Sampling</h2>
<p>Sample from posterior distribution (initialization details in paper).</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">df_samples_subset<span class="op">$</span>term <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(<span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"1st trimester"</span>,</a>
<a class="sourceLine" id="cb24-2" title="2">                                              <span class="st">"3rd trimester"</span>))</a></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">obj =<span class="st"> </span>cytoeffect<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/cytoeffect/topics/poisson_lognormal">poisson_lognormal</a></span>(df_samples_subset, protein_names, </a>
<a class="sourceLine" id="cb25-2" title="2">                                    <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>,</a>
<a class="sourceLine" id="cb25-3" title="3">                                    <span class="dt">iter =</span> <span class="dv">82</span>, <span class="dt">warmup =</span> <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb25-4" title="4">                                    <span class="dt">num_chains =</span> ncores)</a>
<a class="sourceLine" id="cb25-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(obj,<span class="dt">file =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"cytoeffect_poisson_ncells"</span>,ncells,<span class="st">".Rdata"</span>))</a></code></pre></div>
<p>Postprocessing of posterior samples. Traceplot of posterior samples.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">pars_str =<span class="st"> "beta"</span></a>
<a class="sourceLine" id="cb26-2" title="2">rstan<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rstan/topics/stanfit-method-traceplot">traceplot</a></span>(obj<span class="op">$</span>fit_mcmc, <span class="dt">inc_warmup =</span> <span class="ot">FALSE</span>, <span class="dt">pars =</span> pars_str)</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/post_sampling-1.png" width="700"></p>
<p>Some more MCMC diagnostics. According to empirically findings, Rhat &gt; 1.1 is usually indicative of problems in the fit.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">pars =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"beta"</span>,</a>
<a class="sourceLine" id="cb27-2" title="2">         <span class="st">"sigma"</span>,<span class="st">"sigma_term"</span>,<span class="st">"sigma_donor"</span>,</a>
<a class="sourceLine" id="cb27-3" title="3">         <span class="st">"Cor"</span>,<span class="st">"Cor_term"</span>,<span class="st">"Cor_donor"</span>)</a>
<a class="sourceLine" id="cb27-4" title="4">tb =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(obj<span class="op">$</span>fit_mcmc, </a>
<a class="sourceLine" id="cb27-5" title="5">             <span class="dt">pars =</span> pars)<span class="op">$</span>summary <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="st">  </span><span class="kw">as.tibble</span>(<span class="dt">rownames =</span> <span class="st">"pars"</span>, <span class="dt">.before =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-7" title="7"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(pars, n_eff, Rhat)</a>
<a class="sourceLine" id="cb27-8" title="8">tb <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>() <span class="co"># Stan fills upper triangle with zeros</span></a>
<a class="sourceLine" id="cb27-9" title="9">tb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(n_eff)</a></code></pre></div>
<pre><code>## # A tibble: 347 x 3
##    pars           n_eff  Rhat
##    &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt;
##  1 beta[1,1]       112. 1.09 
##  2 beta[1,2]       113. 1.09 
##  3 Cor_donor[9,9]  115. 0.992
##  4 Cor_term[3,6]   129. 1.07 
##  5 Cor_term[6,3]   129. 1.07 
##  6 Cor[3,6]        129. 1.06 
##  7 Cor[6,3]        129. 1.06 
##  8 beta[2,2]       148. 1.05 
##  9 beta[2,1]       149. 1.05 
## 10 beta[3,2]       166. 1.05 
## # ... with 337 more rows</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">tb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(Rhat))</a></code></pre></div>
<pre><code>## # A tibble: 347 x 3
##    pars          n_eff  Rhat
##    &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt;
##  1 beta[1,1]      112.  1.09
##  2 beta[1,2]      113.  1.09
##  3 Cor_term[3,6]  129.  1.07
##  4 Cor_term[6,3]  129.  1.07
##  5 beta[4,1]      167.  1.06
##  6 beta[4,2]      167.  1.06
##  7 Cor[3,6]       129.  1.06
##  8 Cor[6,3]       129.  1.06
##  9 Cor[1,4]       227.  1.05
## 10 Cor[4,1]       227.  1.05
## # ... with 337 more rows</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">tb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">min =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(n_eff), <span class="dt">max =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(n_eff))</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##     min   max
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  112. 1053.</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">tb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">min =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(Rhat), <span class="dt">max =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(Rhat))</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##     min   max
##   &lt;dbl&gt; &lt;dbl&gt;
## 1 0.992  1.09</code></pre>
</div>
</div>
<div id="results" class="section level1">
<h1 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h1>
<p>Plot posterior regression coefficients.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">p1 =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(obj, <span class="dt">type =</span> <span class="st">"beta"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="st">"Fixed Effects"</span><span class="op">~</span>beta)) <span class="op">+</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb35-4" title="4"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">col =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-5" title="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggthemes/topics/scale_few">scale_color_few</a></span>()</a>
<a class="sourceLine" id="cb35-6" title="6">p1</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/plot_beta-1.png" width="700"></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(obj, <span class="dt">type =</span> <span class="st">"beta"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>condition, <span class="dt">scales =</span> <span class="st">"free_x"</span>)</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/plot_beta-2.png" width="700"></p>
<p>Extract expected count difference for pSTAT1.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">post_beta =<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(obj<span class="op">$</span>fit_mcmc, <span class="dt">pars =</span> <span class="st">"beta"</span>)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb37-2" title="2">first_index =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(obj<span class="op">$</span>conditions <span class="op">==</span><span class="st"> "1st trimester"</span>)</a>
<a class="sourceLine" id="cb37-3" title="3">third_index =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(obj<span class="op">$</span>conditions <span class="op">==</span><span class="st"> "3rd trimester"</span>)</a>
<a class="sourceLine" id="cb37-4" title="4">pstat1_index =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(obj<span class="op">$</span>protein_names <span class="op">==</span><span class="st"> "pSTAT1"</span>)</a>
<a class="sourceLine" id="cb37-5" title="5">first_log_count =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(post_beta[,pstat1_index,first_index], </a>
<a class="sourceLine" id="cb37-6" title="6">                           <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</a>
<a class="sourceLine" id="cb37-7" title="7">first_log_count</a></code></pre></div>
<pre><code>##     2.5%      50%    97.5% 
## 2.150289 2.311943 2.475899</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(first_log_count)</a></code></pre></div>
<pre><code>##      2.5%       50%     97.5% 
##  8.587339 10.094014 11.892397</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">third_log_count =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(post_beta[,pstat1_index,third_index], </a>
<a class="sourceLine" id="cb41-2" title="2">                           <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</a>
<a class="sourceLine" id="cb41-3" title="3">third_log_count</a></code></pre></div>
<pre><code>##     2.5%      50%    97.5% 
## 2.508325 2.671118 2.835957</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(third_log_count)</a></code></pre></div>
<pre><code>##     2.5%      50%    97.5% 
## 12.28434 14.45613 17.04671</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">diff_log_count =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(</a>
<a class="sourceLine" id="cb45-2" title="2">  post_beta[,pstat1_index,third_index] <span class="op">-</span><span class="st"> </span>post_beta[,pstat1_index,first_index], </a>
<a class="sourceLine" id="cb45-3" title="3">  <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</a>
<a class="sourceLine" id="cb45-4" title="4">diff_log_count</a></code></pre></div>
<pre><code>##      2.5%       50%     97.5% 
## 0.3512085 0.3586297 0.3655275</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(diff_log_count)</a></code></pre></div>
<pre><code>##     2.5%      50%    97.5% 
## 1.420784 1.431367 1.441274</code></pre>
<p>Plot posterior standard deviation.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">p2 =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(obj, <span class="dt">type =</span> <span class="st">"sigma"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-2" title="2"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Marker Standard Deviation"</span><span class="op">~</span>sigma) <span class="op">+</span></a>
<a class="sourceLine" id="cb49-3" title="3"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb49-4" title="4"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">col =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb49-5" title="5"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"#5DA5DA"</span>, <span class="st">"#FAA43A"</span>, <span class="st">"#F17CB0"</span>))</a>
<a class="sourceLine" id="cb49-6" title="6">p2</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/posterior_sigma-1.png" width="700"></p>
<p>Plot posterior correlations.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1">plist =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(obj, <span class="dt">type =</span> <span class="st">"Cor"</span>)</a>
<a class="sourceLine" id="cb50-2" title="2">plist</a></code></pre></div>
<pre><code>## [[1]]</code></pre>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/posterior_cor-1.png" width="700"></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/posterior_cor-2.png" width="700"></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/posterior_cor-3.png" width="700"></p>
<p>Assess correlation uncertainity.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1">marker_pair =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"pSTAT3"</span>,<span class="st">"pSTAT5"</span>)</a>
<a class="sourceLine" id="cb54-2" title="2">Cor =<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(obj<span class="op">$</span>fit_mcmc, <span class="dt">pars =</span> <span class="st">"Cor"</span>)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb54-3" title="3">Cor_term =<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(obj<span class="op">$</span>fit_mcmc, <span class="dt">pars =</span> <span class="st">"Cor_term"</span>)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb54-4" title="4">Cor_diff =<span class="st"> </span>Cor_term <span class="op">-</span><span class="st"> </span>Cor</a>
<a class="sourceLine" id="cb54-5" title="5">tb_cor =<span class="st"> </span>Cor_diff[,</a>
<a class="sourceLine" id="cb54-6" title="6">                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(protein_names <span class="op">==</span><span class="st"> </span>marker_pair[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb54-7" title="7">                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(protein_names <span class="op">==</span><span class="st"> </span>marker_pair[<span class="dv">2</span>])] <span class="op">%&gt;%</span><span class="st"> </span>as.tibble</a>
<a class="sourceLine" id="cb54-8" title="8">tb_cor <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb54-9" title="9">  <span class="dt">side =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(tb_cor<span class="op">$</span>value <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, </a>
<a class="sourceLine" id="cb54-10" title="10">                 <span class="dt">true =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"positive ("</span>, <span class="dv">100</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(tb_cor<span class="op">$</span>value <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>), <span class="st">"%)"</span>),</a>
<a class="sourceLine" id="cb54-11" title="11">                 <span class="dt">false =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"negative ("</span>, <span class="dv">100</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(tb_cor<span class="op">$</span>value <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>), <span class="st">"%)"</span>))</a>
<a class="sourceLine" id="cb54-12" title="12">)</a>
<a class="sourceLine" id="cb54-13" title="13"><span class="kw">ggplot</span>(tb_cor, <span class="kw">aes</span>(value, <span class="dt">fill =</span> side)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-14" title="14"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">50</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb54-15" title="15"><span class="st">  </span><span class="kw">xlab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"Cor_term("</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(marker_pair, <span class="dt">collapse =</span> <span class="st">", "</span>),<span class="st">")"</span> )) <span class="op">+</span></a>
<a class="sourceLine" id="cb54-16" title="16"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Posterior Distribution"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-17" title="17"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"#E46726"</span>)) <span class="co">#"#6D9EC1"</span></a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/correlation_uncertainty-1.png" width="700"></p>
<p>Check if overall correlation structure changes between conditions.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" title="1">value =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Cor_diff), <span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb55-2" title="2">  mask =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lower.tri">upper.tri</a></span>(Cor_diff[i,,]), <span class="dt">arr.ind =</span> T)</a>
<a class="sourceLine" id="cb55-3" title="3">  cord =<span class="st"> </span>Cor_diff[i,,]</a>
<a class="sourceLine" id="cb55-4" title="4">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(cord[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lower.tri">lower.tri</a></span>(cord)] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb55-5" title="5">})</a>
<a class="sourceLine" id="cb55-6" title="6">tb_cor =<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="dt">value =</span> value)</a>
<a class="sourceLine" id="cb55-7" title="7">tb_cor <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb55-8" title="8">  <span class="dt">side =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(tb_cor<span class="op">$</span>value <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb55-9" title="9">                 <span class="dt">true =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"&gt; 1/2 ("</span>, <span class="dv">100</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(tb_cor<span class="op">$</span>value <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>), <span class="st">"%)"</span>),</a>
<a class="sourceLine" id="cb55-10" title="10">                 <span class="dt">false =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"&lt;= 1/2 ("</span>, <span class="dv">100</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(tb_cor<span class="op">$</span>value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.5</span>), <span class="st">"%)"</span>))</a>
<a class="sourceLine" id="cb55-11" title="11">)</a>
<a class="sourceLine" id="cb55-12" title="12">p_global =<span class="st"> </span><span class="kw">ggplot</span>(tb_cor, <span class="kw">aes</span>(value, <span class="dt">fill =</span> side)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb55-13" title="13"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">25</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb55-14" title="14"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="st">"Overall P(Corr"</span><span class="op">~</span>Omega<span class="op">~</span><span class="st">"(3rd) &gt; Corr"</span><span class="op">~</span>Omega<span class="op">~</span><span class="st">"(1st))"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb55-15" title="15"><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"#E46726"</span>)) <span class="op">+</span><span class="st"> </span><span class="co">#"#6D9EC1"</span></a>
<a class="sourceLine" id="cb55-16" title="16"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb55-17" title="17"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"probability"</span>)</a>
<a class="sourceLine" id="cb55-18" title="18">p_global</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/compare_covariance-1.png" width="700"></p>
<p>Plot differential correlations.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1">cor_increase =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(<span class="dt">X =</span> Cor_diff, <span class="dt">MARGIN =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">FUN =</span> <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb56-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(cor_increase) =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">rownames</a></span>(cor_increase) =<span class="st"> </span>protein_names</a>
<a class="sourceLine" id="cb56-3" title="3">p_local =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcorrplot/topics/ggcorrplot">ggcorrplot</a></span>(cor_increase, <span class="dt">hc.order =</span> <span class="ot">TRUE</span>, <span class="dt">type =</span> <span class="st">"lower"</span>,</a>
<a class="sourceLine" id="cb56-4" title="4">           <span class="dt">outline.col =</span> <span class="st">"lightgray"</span>,</a>
<a class="sourceLine" id="cb56-5" title="5">           <span class="dt">colors =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"#6D9EC1"</span>, <span class="st">"white"</span>, <span class="st">"#E46726"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb56-6" title="6"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="st">"P(Corr"</span><span class="op">~</span>Omega<span class="op">~</span><span class="st">"(3rd) &gt; Corr"</span><span class="op">~</span>Omega<span class="op">~</span><span class="st">"(1st))"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb56-7" title="7"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb56-8" title="8">        <span class="dt">panel.grid.minor =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb56-9" title="9"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">limit =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">midpoint =</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb56-10" title="10">                       <span class="dt">low =</span> <span class="st">"#6D9EC1"</span>, <span class="dt">mid =</span>  <span class="st">"white"</span>, <span class="dt">high =</span> <span class="st">"#E46726"</span>,</a>
<a class="sourceLine" id="cb56-11" title="11">                       <span class="dt">name =</span> <span class="st">"probability"</span>)</a>
<a class="sourceLine" id="cb56-12" title="12">p_local</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/plot_differential_cor-1.png" width="700"></p>
<p>Plot graph with edges at least 95% probability of larger correlation.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" title="1">plot_correlation_graph =<span class="st"> </span><span class="cf">function</span>(lambda) {</a>
<a class="sourceLine" id="cb57-2" title="2">  graph =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(Cor_diff, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(x<span class="op">&gt;</span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb57-3" title="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(graph) =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb57-4" title="4">  graph[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lower.tri">upper.tri</a></span>(graph)] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb57-5" title="5">  ind =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(graph <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">arr.ind =</span> T)</a>
<a class="sourceLine" id="cb57-6" title="6">  tb_graph =<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb57-7" title="7">    <span class="dt">from =</span> protein_names[ind[,<span class="dv">1</span>]],</a>
<a class="sourceLine" id="cb57-8" title="8">    <span class="dt">to =</span> protein_names[ind[,<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb57-9" title="9">    <span class="dt">prob =</span> graph[ind]</a>
<a class="sourceLine" id="cb57-10" title="10">  )</a>
<a class="sourceLine" id="cb57-11" title="11">  tb_graph <span class="op">%&lt;&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(prob <span class="op">&gt;</span><span class="st"> </span>lambda)</a>
<a class="sourceLine" id="cb57-12" title="12">  tb_graph</a>
<a class="sourceLine" id="cb57-13" title="13">  bayesFDR =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="dv">1</span><span class="op">-</span>tb_graph<span class="op">$</span>prob)<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(tb_graph)<span class="op">*</span><span class="dv">100</span></a>
<a class="sourceLine" id="cb57-14" title="14">  bayesFDR</a>
<a class="sourceLine" id="cb57-15" title="15">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">0xdada</span>)</a>
<a class="sourceLine" id="cb57-16" title="16">  ig =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/igraph/topics/graph_from_data_frame">graph_from_data_frame</a></span>(tb_graph, <span class="dt">directed =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb57-17" title="17">  <span class="kw">ggplot</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/ggnetwork/topics/ggnetwork">ggnetwork</a></span>(ig, <span class="dt">layout =</span> <span class="st">"circle"</span>), <span class="kw">aes</span>(x, y, <span class="dt">xend =</span> xend, <span class="dt">yend =</span> yend)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-18" title="18"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggnetwork/topics/geom_edges">geom_edges</a></span>(<span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-19" title="19"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggnetwork/topics/geom_nodes">geom_nodes</a></span>(<span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="dv">20</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-20" title="20"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggnetwork/topics/geom_nodetext">geom_nodetext</a></span>(<span class="kw">aes</span>(<span class="dt">label =</span> vertex.names), </a>
<a class="sourceLine" id="cb57-21" title="21">                  <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">fontface =</span> <span class="st">"bold"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-22" title="22"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">xlim</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>, <span class="fl">1.1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-23" title="23"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot.window">ylim</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>, <span class="fl">1.1</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-24" title="24"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"Posterior Expected FDR: "</span>, </a>
<a class="sourceLine" id="cb57-25" title="25">                   <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(bayesFDR, <span class="dt">digits =</span> <span class="dv">1</span>),<span class="st">"%"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-26" title="26"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggnetwork/topics/theme_blank">theme_blank</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb57-27" title="27"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb57-28" title="28">}</a>
<a class="sourceLine" id="cb57-29" title="29"><span class="kw">plot_correlation_graph</span>(<span class="dt">lambda =</span> <span class="fl">0.8</span>)</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/plot_graph-1.png" width="700"></p>
<p>Combine plot for paper.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1">pall =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/cowplot/topics/plot_grid">plot_grid</a></span>(</a>
<a class="sourceLine" id="cb58-2" title="2">  p1, p2, </a>
<a class="sourceLine" id="cb58-3" title="3">  plist[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="st">"Marker Corr"</span><span class="op">~</span>Omega<span class="op">~</span><span class="st">"(1st trimester)"</span>)),</a>
<a class="sourceLine" id="cb58-4" title="4">  plist[[<span class="dv">2</span>]] <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="st">"Marker Corr"</span><span class="op">~</span>Omega<span class="op">~</span><span class="st">"(3rd trimester)"</span>)),</a>
<a class="sourceLine" id="cb58-5" title="5">  p_global, p_local, </a>
<a class="sourceLine" id="cb58-6" title="6">  <span class="dt">rel_heights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.38</span>,<span class="fl">0.31</span>,<span class="fl">0.31</span>),</a>
<a class="sourceLine" id="cb58-7" title="7">  <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">labels =</span> <span class="st">"AUTO"</span></a>
<a class="sourceLine" id="cb58-8" title="8">)</a>
<a class="sourceLine" id="cb58-9" title="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/cowplot/topics/ggsave">ggsave</a></span>(<span class="dt">plot =</span> pall, </a>
<a class="sourceLine" id="cb58-10" title="10">       <span class="dt">filename =</span> <span class="st">"posterior_summary_plmm.pdf"</span>, </a>
<a class="sourceLine" id="cb58-11" title="11">       <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">11</span>)</a></code></pre></div>
</div>
<div id="goodness-of-fit" class="section level1">
<h1 class="hasAnchor">
<a href="#goodness-of-fit" class="anchor"></a>Goodness of Fit</h1>
<p>Define a test statistics and compare observed value with posterior predictive distribution.</p>
<p>Predictive distribution marginalized over cell random effects.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1">stan_pars =<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(obj<span class="op">$</span>fit_mcmc, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"beta"</span>,</a>
<a class="sourceLine" id="cb59-2" title="2">                                                  <span class="st">"sigma"</span>,<span class="st">"sigma_term"</span>,<span class="st">"sigma_donor"</span>,</a>
<a class="sourceLine" id="cb59-3" title="3">                                                  <span class="st">"Cor"</span>,<span class="st">"Cor_term"</span>,<span class="st">"Cor_donor"</span>))</a>
<a class="sourceLine" id="cb59-4" title="4">condition =<span class="st"> "term"</span></a>
<a class="sourceLine" id="cb59-5" title="5">term =<span class="st"> </span>df_samples_subset <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-6" title="6"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(condition) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-7" title="7"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-8" title="8"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>()</a>
<a class="sourceLine" id="cb59-9" title="9"><span class="co"># kth posterior draw</span></a>
<a class="sourceLine" id="cb59-10" title="10">sample_y_hat =<span class="st"> </span><span class="cf">function</span>(<span class="dt">k =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb59-11" title="11">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(cond) {</a>
<a class="sourceLine" id="cb59-12" title="12">    n_cells_cond =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(term)[cond]</a>
<a class="sourceLine" id="cb59-13" title="13">    beta =<span class="st"> </span>stan_pars<span class="op">$</span>beta[k,,]</a>
<a class="sourceLine" id="cb59-14" title="14">    mu =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(protein_names))</a>
<a class="sourceLine" id="cb59-15" title="15">    beta_rep =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(beta[,cond], rep, n_cells_cond)</a>
<a class="sourceLine" id="cb59-16" title="16">    sigma =<span class="st"> </span>stan_pars<span class="op">$</span>sigma[k,]</a>
<a class="sourceLine" id="cb59-17" title="17">    Cor =<span class="st"> </span>stan_pars<span class="op">$</span>Cor[k,,]</a>
<a class="sourceLine" id="cb59-18" title="18">    Cov =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(sigma) <span class="op">%*%</span><span class="st"> </span>Cor <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(sigma)</a>
<a class="sourceLine" id="cb59-19" title="19">    b =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dt">n =</span> n_cells_cond, mu, Cov)</a>
<a class="sourceLine" id="cb59-20" title="20">    sigma_donor =<span class="st"> </span>stan_pars<span class="op">$</span>sigma_donor[k,]</a>
<a class="sourceLine" id="cb59-21" title="21">    Cor_donor =<span class="st"> </span>stan_pars<span class="op">$</span>Cor_donor[k,,]</a>
<a class="sourceLine" id="cb59-22" title="22">    Cov_donor =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(sigma_donor) <span class="op">%*%</span><span class="st"> </span>Cor_donor <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(sigma_donor)</a>
<a class="sourceLine" id="cb59-23" title="23">    b_donor =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dt">n =</span> n_cells_cond, mu, Cov_donor)</a>
<a class="sourceLine" id="cb59-24" title="24">    count =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(beta_rep <span class="op">+</span><span class="st"> </span>b <span class="op">+</span><span class="st"> </span>b_donor)</a>
<a class="sourceLine" id="cb59-25" title="25">    count =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Poisson">rpois</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(count), count),</a>
<a class="sourceLine" id="cb59-26" title="26">                   <span class="dt">nrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(count), </a>
<a class="sourceLine" id="cb59-27" title="27">                   <span class="dt">ncol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(count))</a>
<a class="sourceLine" id="cb59-28" title="28">    count <span class="op">%&lt;&gt;%</span><span class="st"> </span>as.tibble</a>
<a class="sourceLine" id="cb59-29" title="29">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(count) =<span class="st"> </span>protein_names</a>
<a class="sourceLine" id="cb59-30" title="30">    count <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">add_column</span>(<span class="dt">term  =</span> obj<span class="op">$</span>conditions[cond])</a>
<a class="sourceLine" id="cb59-31" title="31">    count</a>
<a class="sourceLine" id="cb59-32" title="32">  }) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</a>
<a class="sourceLine" id="cb59-33" title="33">}</a>
<a class="sourceLine" id="cb59-34" title="34">Y_hat =<span class="st"> </span><span class="kw">sample_y_hat</span>(<span class="dt">k =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb59-35" title="35">Y_hat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb59-36" title="36"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(term) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb59-37" title="37"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarize_at</a></span>(protein_names, median)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 11
##   term pCREB pSTAT5  pP38 pSTAT1 pSTAT3 prpS6 pMAPKAPK   IkB pNFkB pERK1_2
##   &lt;ch&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;
## 1 1stâ€¦     8      4     2      9      9     4       20     4     7       0
## 2 3rdâ€¦     9      4     2     13      9     4       20     4     8       0</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1">df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-2" title="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(term) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-3" title="3"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarize_at</a></span>(protein_names, median)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 11
##   term pCREB pSTAT5  pP38 pSTAT1 pSTAT3 prpS6 pMAPKAPK   IkB pNFkB pERK1_2
##   &lt;fc&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
## 1 1stâ€¦     8      4     3     10      9     4       22     5     7       0
## 2 3rdâ€¦     9      4     3     14      9     5       22     5     8       0</code></pre>
<p>Check if we can model pSTAT, pSTAT3, and pSTAT5 bright cells.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" title="1">gof =<span class="st"> </span><span class="cf">function</span>(df, test_stat) {</a>
<a class="sourceLine" id="cb63-2" title="2">  tfm =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Hyperbolic">asinh</a></span>(x<span class="op">/</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb63-3" title="3">  df_tfm =<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">mutate_at</a></span>(protein_names, tfm)</a>
<a class="sourceLine" id="cb63-4" title="4">  df_median =<span class="st"> </span>df_tfm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarize_at</a></span>(protein_names, median)</a>
<a class="sourceLine" id="cb63-5" title="5">  <span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb63-6" title="6">    <span class="dt">term =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb63-7" title="7">      <span class="st">"1st trimester"</span>, </a>
<a class="sourceLine" id="cb63-8" title="8">      <span class="st">"3rd trimester"</span></a>
<a class="sourceLine" id="cb63-9" title="9">      ),</a>
<a class="sourceLine" id="cb63-10" title="10">    <span class="dt">statistic =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb63-11" title="11">      <span class="kw">test_stat</span>(df_tfm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(term <span class="op">==</span><span class="st"> "1st trimester"</span>), df_median), </a>
<a class="sourceLine" id="cb63-12" title="12">      <span class="kw">test_stat</span>(df_tfm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(term <span class="op">==</span><span class="st"> "3rd trimester"</span>), df_median)</a>
<a class="sourceLine" id="cb63-13" title="13">      )</a>
<a class="sourceLine" id="cb63-14" title="14">  )</a>
<a class="sourceLine" id="cb63-15" title="15">}</a>
<a class="sourceLine" id="cb63-16" title="16">test_stat_a =<span class="st"> </span><span class="cf">function</span>(df_tfm, df_median) {</a>
<a class="sourceLine" id="cb63-17" title="17">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(df_tfm<span class="op">$</span>pSTAT1 <span class="op">&gt;</span><span class="st"> </span>df_median<span class="op">$</span>pSTAT1 <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb63-18" title="18"><span class="st">       </span>df_tfm<span class="op">$</span>pSTAT3 <span class="op">&gt;</span><span class="st"> </span>df_median<span class="op">$</span>pSTAT3 <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb63-19" title="19"><span class="st">       </span>df_tfm<span class="op">$</span>pSTAT5 <span class="op">&gt;</span><span class="st"> </span>df_median<span class="op">$</span>pSTAT5) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb63-20" title="20">}</a>
<a class="sourceLine" id="cb63-21" title="21">gof_obsv_a =<span class="st"> </span><span class="kw">gof</span>(df_samples_subset, test_stat_a)</a>
<a class="sourceLine" id="cb63-22" title="22">gof_pred_a =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(stan_pars<span class="op">$</span>beta)[<span class="dv">1</span>], <span class="cf">function</span>(k) <span class="kw">gof</span>(<span class="kw">sample_y_hat</span>(k), test_stat_a),</a>
<a class="sourceLine" id="cb63-23" title="23">                      <span class="dt">mc.cores =</span> ncores) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</a>
<a class="sourceLine" id="cb63-24" title="24">gof_obsv_a <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset A"</span>)</a>
<a class="sourceLine" id="cb63-25" title="25">gof_pred_a <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset A"</span>)</a></code></pre></div>
<p>Check if we can model pSTAT bright, and pSTAT3 and pSTAT5 dim cells.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" title="1">test_stat_b =<span class="st"> </span><span class="cf">function</span>(df_tfm, df_median) {</a>
<a class="sourceLine" id="cb64-2" title="2">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(df_tfm<span class="op">$</span>pSTAT1 <span class="op">&gt;</span><span class="st"> </span>df_median<span class="op">$</span>pSTAT1 <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-3" title="3"><span class="st">       </span>df_tfm<span class="op">$</span>pSTAT3 <span class="op">&lt;</span><span class="st"> </span>df_median<span class="op">$</span>pSTAT3 <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-4" title="4"><span class="st">       </span>df_tfm<span class="op">$</span>pSTAT5 <span class="op">&lt;</span><span class="st"> </span>df_median<span class="op">$</span>pSTAT5) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb64-5" title="5">}</a>
<a class="sourceLine" id="cb64-6" title="6">gof_obsv_b =<span class="st"> </span><span class="kw">gof</span>(df_samples_subset, test_stat_b)</a>
<a class="sourceLine" id="cb64-7" title="7">gof_pred_b =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(stan_pars<span class="op">$</span>beta)[<span class="dv">1</span>], <span class="cf">function</span>(k) <span class="kw">gof</span>(<span class="kw">sample_y_hat</span>(k), test_stat_b),</a>
<a class="sourceLine" id="cb64-8" title="8">                      <span class="dt">mc.cores =</span> ncores) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</a>
<a class="sourceLine" id="cb64-9" title="9">gof_obsv_b <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset B"</span>)</a>
<a class="sourceLine" id="cb64-10" title="10">gof_pred_b <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset B"</span>)</a></code></pre></div>
<p>Check if we can model zero pERK1_2 and pMAPKAPK bright cells.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1">test_stat_c =<span class="st"> </span><span class="cf">function</span>(df_tfm, df_median) {</a>
<a class="sourceLine" id="cb65-2" title="2">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(df_tfm<span class="op">$</span>pERK1_<span class="dv">2</span>  <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-3" title="3"><span class="st">       </span>df_tfm<span class="op">$</span>pMAPKAPK <span class="op">&gt;</span><span class="st"> </span>df_median<span class="op">$</span>pMAPKAPK) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb65-4" title="4">}</a>
<a class="sourceLine" id="cb65-5" title="5">gof_obsv_c =<span class="st"> </span><span class="kw">gof</span>(df_samples_subset, test_stat_c)</a>
<a class="sourceLine" id="cb65-6" title="6">gof_pred_c =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(stan_pars<span class="op">$</span>beta)[<span class="dv">1</span>], <span class="cf">function</span>(k) <span class="kw">gof</span>(<span class="kw">sample_y_hat</span>(k), test_stat_c),</a>
<a class="sourceLine" id="cb65-7" title="7">                      <span class="dt">mc.cores =</span> ncores) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</a>
<a class="sourceLine" id="cb65-8" title="8">gof_obsv_c <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset C"</span>)</a>
<a class="sourceLine" id="cb65-9" title="9">gof_pred_c <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset C"</span>)</a></code></pre></div>
<p>Check if we can model nonzero pERK1_2 and pMAPKAPK bright cells.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" title="1">test_stat_d =<span class="st"> </span><span class="cf">function</span>(df_tfm, df_median) {</a>
<a class="sourceLine" id="cb66-2" title="2">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(df_tfm<span class="op">$</span>pERK1_<span class="dv">2</span>  <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-3" title="3"><span class="st">       </span>df_tfm<span class="op">$</span>pMAPKAPK <span class="op">&gt;</span><span class="st"> </span>df_median<span class="op">$</span>pMAPKAPK</a>
<a class="sourceLine" id="cb66-4" title="4">       ) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb66-5" title="5">}</a>
<a class="sourceLine" id="cb66-6" title="6">gof_obsv_d =<span class="st"> </span><span class="kw">gof</span>(df_samples_subset, test_stat_d)</a>
<a class="sourceLine" id="cb66-7" title="7">gof_pred_d =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(stan_pars<span class="op">$</span>beta)[<span class="dv">1</span>], <span class="cf">function</span>(k) <span class="kw">gof</span>(<span class="kw">sample_y_hat</span>(k), test_stat_d),</a>
<a class="sourceLine" id="cb66-8" title="8">                      <span class="dt">mc.cores =</span> ncores) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</a>
<a class="sourceLine" id="cb66-9" title="9">gof_obsv_d <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset D"</span>)</a>
<a class="sourceLine" id="cb66-10" title="10">gof_pred_d <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subset =</span> <span class="st">"Cell Subset D"</span>)</a></code></pre></div>
<p>Combined plot for paper.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" title="1"><span class="co"># combine observed statistic</span></a>
<a class="sourceLine" id="cb67-2" title="2">gof_obsv_all =<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(gof_obsv_a, gof_obsv_b, gof_obsv_c, gof_obsv_d)</a>
<a class="sourceLine" id="cb67-3" title="3"><span class="co"># combined predicted statistic</span></a>
<a class="sourceLine" id="cb67-4" title="4">gof_pred_all =<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(gof_pred_a, gof_pred_b, gof_pred_c, gof_pred_d)</a>
<a class="sourceLine" id="cb67-5" title="5"><span class="co"># plot everything</span></a>
<a class="sourceLine" id="cb67-6" title="6"><span class="kw">ggplot</span>(gof_pred_all, <span class="kw">aes</span>(statistic, <span class="dt">fill =</span> term)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-7" title="7"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">40</span>, <span class="dt">position =</span> <span class="st">"identity"</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb67-8" title="8"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> gof_obsv_all, <span class="dt">linetype =</span> <span class="st">"dashed"</span>, <span class="dt">size =</span> <span class="dv">1</span>, </a>
<a class="sourceLine" id="cb67-9" title="9">             <span class="kw">aes</span>(<span class="dt">xintercept =</span> statistic, <span class="dt">color =</span> term)) <span class="op">+</span></a>
<a class="sourceLine" id="cb67-10" title="10"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggthemes/topics/scale_few">scale_fill_few</a></span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-11" title="11"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggthemes/topics/scale_few">scale_color_few</a></span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-12" title="12"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"test statistic (percentage)"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-13" title="13"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>subset, <span class="dt">scales =</span> <span class="st">"free"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb67-14" title="14"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"bottom"</span>)</a></code></pre></div>
<p><img src="Reanalysis_Aghaeepour2017_Poisson_files/figure-html/goodness_of_fit_combined-1.png" width="700"></p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/cowplot/topics/ggsave">ggsave</a></span>(<span class="dt">filename =</span> <span class="st">"goodness_of_fit.pdf"</span>, </a>
<a class="sourceLine" id="cb68-2" title="2">       <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">5</span>)</a></code></pre></div>
</div>
<div id="session-info" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h1>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/sessionInfo">sessionInfo</a></span>()</a></code></pre></div>
<pre><code>## R version 3.5.1 (2018-07-02)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS  10.14.3
## 
## Matrix products: default
## BLAS: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] sna_2.4                     network_1.13.0.1           
##  [3] statnet.common_4.2.0        hexbin_1.27.2              
##  [5] bindrcpp_0.2.2              MASS_7.3-51                
##  [7] ggcorrplot_0.1.2            ggnetwork_0.5.1            
##  [9] igraph_1.2.2                intergraph_2.0-2           
## [11] broom_0.5.0                 RColorBrewer_1.1-2         
## [13] cowplot_0.9.3               ggthemes_4.0.1             
## [15] SummarizedExperiment_1.10.1 DelayedArray_0.6.6         
## [17] BiocParallel_1.14.2         matrixStats_0.54.0         
## [19] Biobase_2.40.0              GenomicRanges_1.32.7       
## [21] GenomeInfoDb_1.16.0         IRanges_2.14.12            
## [23] S4Vectors_0.18.3            BiocGenerics_0.26.0        
## [25] magrittr_1.5                forcats_0.3.0              
## [27] stringr_1.3.1               dplyr_0.7.7                
## [29] purrr_0.2.5                 readr_1.1.1                
## [31] tidyr_0.8.2                 tibble_1.4.2               
## [33] ggplot2_3.1.0               tidyverse_1.2.1            
## [35] cytoeffect_0.1.0            Rcpp_0.12.19               
## [37] BiocStyle_2.8.2            
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.3-2       rprojroot_1.3-2        XVector_0.20.0        
##  [4] base64enc_0.1-3        fs_1.2.6               rstudioapi_0.8        
##  [7] roxygen2_6.1.1         rstan_2.18.1           ggrepel_0.8.0         
## [10] fansi_0.4.0            lubridate_1.7.4        xml2_1.2.0            
## [13] knitr_1.20             jsonlite_1.5           compiler_3.5.1        
## [16] httr_1.3.1             backports_1.1.2        assertthat_0.2.0      
## [19] Matrix_1.2-14          lazyeval_0.2.1         cli_1.0.1             
## [22] htmltools_0.3.6        prettyunits_1.0.2      tools_3.5.1           
## [25] coda_0.19-2            gtable_0.2.0           glue_1.3.0            
## [28] GenomeInfoDbData_1.1.0 reshape2_1.4.3         batchtools_0.9.11     
## [31] rappdirs_0.3.1         cellranger_1.1.0       pkgdown_1.3.0         
## [34] nlme_3.1-137           xfun_0.4               ps_1.2.0              
## [37] rvest_0.3.2            zlibbioc_1.26.0        scales_1.0.0          
## [40] hms_0.4.2              inline_0.3.15          yaml_2.2.0            
## [43] memoise_1.1.0          gridExtra_2.3          loo_2.0.0             
## [46] StanHeaders_2.18.0     stringi_1.2.4          desc_1.2.0            
## [49] checkmate_1.8.5        pkgbuild_1.0.2         rlang_0.3.0.1         
## [52] pkgconfig_2.0.2        commonmark_1.7         bitops_1.0-6          
## [55] evaluate_0.12          lattice_0.20-35        bindr_0.1.1           
## [58] labeling_0.3           processx_3.2.0         tidyselect_0.2.5      
## [61] plyr_1.8.4             bookdown_0.7           R6_2.3.0              
## [64] base64url_1.4          pillar_1.3.0           haven_1.1.2           
## [67] withr_2.1.2            RCurl_1.95-4.11        modelr_0.1.2          
## [70] crayon_1.3.4           utf8_1.1.4             rmarkdown_1.10        
## [73] progress_1.2.0         grid_3.5.1             readxl_1.1.0          
## [76] data.table_1.11.8      callr_3.0.0            digest_0.6.18         
## [79] brew_1.0-6             munsell_0.5.0</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-aghaeepour2017immune">
<p>Aghaeepour, Nima, Edward A. Ganio, David Mcilwain, Amy S. Tsai, Martha Tingle, Van GassenSofie, Dyani K. Gaudilliere, et al. 2017. â€œAn Immune Clock of Human Pregnancy.â€ <em>Science Immunology</em> 2 (15): eaan2946. <a href="https://doi.org/10.1126/sciimmunol.aan2946">https://doi.org/10.1126/sciimmunol.aan2946</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#goal">Goal</a></li>
      <li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#load-data">Load Data</a></li>
      <li>
<a href="#fit-model">Fit Model</a><ul class="nav nav-pills nav-stacked">
<li><a href="#subsampling">Subsampling</a></li>
      <li><a href="#hmc-sampling">HMC Sampling</a></li>
      </ul>
</li>
      <li><a href="#results">Results</a></li>
      <li><a href="#goodness-of-fit">Goodness of Fit</a></li>
      <li><a href="#session-info">Session Info</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christof Seiler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
