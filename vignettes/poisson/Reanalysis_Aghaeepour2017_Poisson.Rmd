---
title: "Poisson Log-Normal Mixed Model"
author:
  name: Christof Seiler
  affiliation: Department of Statistics, Stanford University
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Goal

Reanalysis of mass cytometry data from @aghaeepour2017immune using the Poisson Log-Normal Mixed Model.

# Prerequisites

Parse input parameters.

```{r parse_input_parameters}
ncells = Inf
seed = 0xdada
ncores = 8
zenodo_url = "https://zenodo.org/record/2652578/files/"
cytof_data = "se_aghaeepour2017immune.Rdata"
prefit = paste0("cytoeffect_plmm_ncells_",ncells,".Rdata")
prefit
```

Install packages.

```{r install_packages, warning=FALSE, message=FALSE, eval=FALSE}
pkgs_needed = c("devtools","tidyverse","magrittr","SummarizedExperiment",
                "ggthemes","cowplot","RColorBrewer","broom","hexbin",
                "intergraph","igraph","ggnetwork","ggcorrplot","MASS",
                "parallel","dplyr")
letsinstall = setdiff(pkgs_needed, installed.packages())
if (length(letsinstall) > 0) {
  BiocManager::install(letsinstall)
}
devtools::install_github("ChristofSeiler/cytoeffect")
```

Load packages.

```{r load_packages}
library("cytoeffect")
library("tidyverse")
library("magrittr")
library("SummarizedExperiment")
library("ggthemes")
library("cowplot")
library("RColorBrewer")
library("broom")
library("intergraph")
library("igraph")
library("ggnetwork")
library("ggcorrplot")
library("MASS")
library("parallel")
library("dplyr")
theme_set(theme_few())
```

# Load Data

Download preprocessed data from Zenodo.

```{r download_zenodo}
rdata_filenames = c(cytof_data, prefit)
for(filename in rdata_filenames)
    download.file(url = paste0(zenodo_url, filename),
                  destfile = filename,
                  mode = "wb")
```

Load ``SummarizedExperiment`` object from CytoGLMM workflow.

```{r load_summarized_experiment}
load(cytof_data)
exprs = assay(se_aghaeepour2017immune)
sample_info = rowData(se_aghaeepour2017immune)
sample_info_names = names(sample_info)
df_samples = cbind(as.data.frame(exprs), as.data.frame(sample_info))
df_samples %<>% as.tibble
protein_names = colData(se_aghaeepour2017immune) %>%
  as.data.frame %>%
  dplyr::filter(type == "function") %>%
  .$protein_name
gate_protein_names = colData(se_aghaeepour2017immune) %>%
  as.data.frame %>%
  dplyr::filter(type == "phenotype") %>%
  .$protein_name
```

# Fit Model

Tally cell count.

```{r cell_count}
df_samples %>% group_by(term,celltype,donor) %>% tally %>% arrange(n)
df_samples %>% group_by(term,celltype,donor) %>% tally %>% arrange(desc(n))
```

Subset to NK cells.

```{r one_donor_one_cell_subset}
df_samples_subset = df_samples %>% dplyr::filter(celltype == "NK")
df_samples_subset %<>% dplyr::select(protein_names,gate_protein_names,sample_info_names)
```

Subsample cells to a maximum number of cells per donor.

```{r subsample_cells}
if(nrow(df_samples_subset) > ncells) {
  print(paste("subsampled to",ncells,"per donor"))
  set.seed(seed)
  # subsample depending on max cell count
  df_count = df_samples_subset %>% group_by(donor) %>% tally() %>%
    mutate(nnew = ifelse(n > ncells,ncells,n))
  # create table with a data frame in one column
  df_nested = df_samples_subset %>% group_by(donor) %>% nest() %>%
    left_join(df_count,by = "donor")
  # subsample per donor
  df_samples_subset = df_nested %>%
    mutate(samp = map2(data, nnew, sample_n)) %>%
    dplyr::select(donor, samp) %>%
    unnest()
} else {
  print("no subsampling done")
}
```

Tally cell count.

```{r cell_count_subsample}
df_samples_subset %>% group_by(term,celltype,donor) %>% tally %>%
  arrange(n)
df_samples_subset %>% group_by(term,celltype,donor) %>% tally %>%
  arrange(desc(n))
```

## HMC Sampling

Sample from posterior distribution (initialization details in paper).

```{r set_reference}
df_samples_subset$term %<>% factor(levels = c("1st trimester",
                                              "3rd trimester"))
```

```{r poisson_sampling}
if(file.exists(prefit)) {
  load(file = prefit)
} else {
  obj = cytoeffect::poisson_lognormal(df_samples_subset, protein_names,
                                      condition = "term", group = "donor",
                                      r_donor = 3,
                                      iter = 325, warmup = 200,
                                      num_chains = ncores)
  save(obj,file = prefit)
}
```

## HMC Diagnostics

Postprocessing of posterior samples. Traceplot of posterior samples.

```{r post_sampling, fig.wide=TRUE}
pars_str = "beta"
rstan::traceplot(obj$fit_mcmc, inc_warmup = FALSE, pars = pars_str)
# test case
stan_pars = rstan::extract(obj$fit_mcmc,
                           pars = c("sigma_donor", "Q_donor", "Cor_donor"))
k = 100
sigma = stan_pars$sigma_donor[k,]
Q = stan_pars$Q_donor[k,,]
cor = cov2cor(Q %*% diag(sigma^2) %*% t(Q))
range(cor - stan_pars$Cor_donor[k,,])
```

Some more MCMC diagnostics. According to empirically findings, Rhat > 1.1 is usually indicative of problems in the fit.

```{r mcmc_diagnostics}
tidyMCMC(
  obj$fit_mcmc,
  pars = c("beta","sigma","sigma_donor",
           "Cor","Cor_donor","b_donor"),
  rhat = TRUE, ess = TRUE
  ) %>% arrange(desc(rhat))
```

# Results

Plot posterior regression coefficients.

```{r plot_beta}
p_beta = plot(obj, type = "beta") +
  theme(legend.position = "bottom", plot.title = element_blank()) +
  guides(col = guide_legend(ncol = 1)) +
  scale_color_few()
p_beta
plot(obj, type = "beta") +
  facet_wrap(~condition, scales = "free_x") +
  theme(legend.position = "bottom") +
  guides(col = guide_legend(ncol = 1)) +
  scale_color_few()
```

Extract expected count difference for pSTAT1.

```{r fixed_effects_pSTAT1}
post_beta = rstan::extract(obj$fit_mcmc, pars = "beta")[[1]]
first_index = which(levels(pull(obj$df_samples_subset, obj$condition))
                    == "1st trimester")
third_index = which(levels(pull(obj$df_samples_subset, obj$condition))
                    == "3rd trimester")
pstat1_index = which(obj$protein_names == "pSTAT1")
first_log_count = quantile(post_beta[,pstat1_index,first_index],
                           probs = c(0.025, 0.5, 0.975))
first_log_count
exp(first_log_count)
third_log_count = quantile(post_beta[,pstat1_index,third_index],
                           probs = c(0.025, 0.5, 0.975))
third_log_count
exp(third_log_count)
diff_log_count = quantile(
  post_beta[,pstat1_index,third_index] - post_beta[,pstat1_index,first_index],
  probs = c(0.025, 0.5, 0.975))
diff_log_count
exp(diff_log_count)
```

Posterior multivariate pairs plot.

```{r posterior_pair_plot}
p_beta_pairs = cytoeffect::plot_pairs(obj, "pSTAT1", "pSTAT3", "pSTAT5")
ggsave(plot_grid(p_beta, NULL, p_beta_pairs, nrow = 1, rel_widths = c(0.35, 0.05, 0.6)),
       filename = "posterior_beta.pdf", width = 10, height = 5)
```

Plot posterior standard deviation.

```{r posterior_sigma}
plot(obj, type = "sigma") +
  ggtitle("Marker Standard Deviation"~sigma) +
  theme(legend.position = "bottom") +
  guides(col = guide_legend(ncol = 1)) +
  scale_color_manual(values=c("#60BD68", "#F17CB0"))
```

Plot posterior correlations.

```{r posterior_cor}
plist = plot(obj, type = "Cor")
plist
```

Plot posterior zero-inflation probability.

```{r posterior_theta}
plot(obj, type = "theta") + coord_flip()
ggsave(filename = "posterior_theta.pdf", width = 7, height = 4)
```

Multivariate posterior MDS plots.

```{r multivariate_posterior}
cytoeffect::plot_mds(obj)
ggsave(filename = "posterior_lambda_scaled.pdf", width = 10, height = 5)
cytoeffect::plot_mds(obj, asp = FALSE)
ggsave(filename = "posterior_lambda_unscaled.pdf", width = 10, height = 5)
cytoeffect::plot_mds(obj, asp = FALSE, show_donors = FALSE)
ggsave(filename = "posterior_lambda_unscaled_no_donors.pdf",
       width = 10, height = 5)
```

# Goodness of Fit

Define a test statistics and compare observed value with posterior predictive distribution.

```{r marginal_predicted_counts}
sample_y_hat = function(k) {
  tb = posterior_predictive_log_lambda(obj, k = 1, show_donors = TRUE)
  lambda_matrix = tb %>%
    dplyr::select(obj$protein_names) %>%
    as.matrix %>%
    exp
  Y_hat = matrix(rpois(length(lambda_matrix), lambda_matrix),
                   nrow = nrow(lambda_matrix),
                   ncol = ncol(lambda_matrix))
  tb[1:length(obj$protein_names)] = Y_hat
  tb
}
Y_hat = sample_y_hat(k = 1)
Y_hat %>%
  group_by(term) %>%
  summarize_at(obj$protein_names, median)
obj$df_samples_subset %>%
  group_by(term) %>%
  summarize_at(obj$protein_names, median)
```

Four checks:

* Subset A: Check if we can model pSTAT1, pSTAT3, and pSTAT5 bright cells
* Subset B: Check if we can model pSTAT1 bright, and pSTAT3 and pSTAT5 dim cells
* Subset C: Check if we can model zero pERK1_2 and pMAPKAPK bright cells
* Subset D: Check if we can model nonzero pERK1_2 and pMAPKAPK bright cells

```{r goodness_of_fit}
set.seed(0xdada)
pSTAT1_median = median(obj$df_samples_subset$pSTAT1)
pSTAT3_median = median(obj$df_samples_subset$pSTAT3)
pSTAT5_median = median(obj$df_samples_subset$pSTAT5)
pMAPKAPK_median = median(obj$df_samples_subset$pMAPKAPK)
gof = function(tb) {
  tb %>%
    group_by(term, donor) %>%
    summarize(
      pSTAT_bright = mean(pSTAT1 > pSTAT1_median &
                          pSTAT3 > pSTAT3_median &
                          pSTAT5 > pSTAT5_median),
      pSTAT1_bright_35_dim = mean(pSTAT1 > pSTAT1_median &
                                  pSTAT3 < pSTAT3_median &
                                  pSTAT5 < pSTAT5_median),
      pERK1_2_zero = mean(pERK1_2  == 0),
      pMAPKAPK_nonzero = mean(pMAPKAPK > pMAPKAPK_median),
      pSTAT1_zero = mean(pSTAT1 == 0),
      pSTAT1_median = median(pSTAT1),
      )
}
n_iter = nrow(rstan::extract(obj$fit_mcmc, pars = "beta")[[1]])
gof_pred = mclapply(1:n_iter, function(k) gof(sample_y_hat(k)),
                    mc.cores = ncores, mc.set.seed = FALSE) %>% bind_rows()
gof_obsv = gof(obj$df_samples_subset)
```

Observed test statistic (vertical dashed line) should be in the bulk of the distribution.

```{r plot_goodness_of_fit}
gof_pred_long = gof_pred %>%
  gather(subset, statistic, -term, -donor)
gof_obsv_long = gof_obsv %>%
  gather(subset, statistic, -term, -donor)
ggplot(gof_pred_long, aes(statistic, fill = term)) +
  geom_histogram(bins = 40, position = "identity", alpha = 0.5) +
  geom_point(data = gof_obsv_long,
             position = position_jitter(width = 0, height = 50), alpha = 0.8,
             aes(y = 0, x = statistic, color = term)) +
  scale_fill_few() +
  scale_color_few() +
  xlab("test statistic") +
  facet_wrap(~subset, scales = "free") +
  theme(legend.position="bottom") +
  ggtitle("All Donors")
ggsave(filename = "goodness_of_fit.pdf",
       width = 10, height = 5)
```

# Session Info {.unnumbered}

```{r session_info}
sessionInfo()
```

# References {.unnumbered}
