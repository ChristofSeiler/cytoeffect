---
title: "Confounders and Biases"
author:
  name: Christof Seiler
  affiliation: Maastricht University
output:
  BiocStyle::html_document:
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Goal

Compare resonse and predictor models with respect to confounders.

# Prerequisites

Install packages.

```{r install_packages, warning=FALSE, message=FALSE, eval=TRUE}
pkgs_needed = c("devtools","tidyverse","magrittr",
                "RColorBrewer", "cowplot", "ggthemes","MASS",
                "rstan","ggdag")
letsinstall = setdiff(pkgs_needed, installed.packages())
if (length(letsinstall) > 0) {
  source("http://bioconductor.org/biocLite.R")
  biocLite(letsinstall)
}
```

Load packages.

```{r load_packages}
library("tidyverse")
library("magrittr")
library("broom")
library("RColorBrewer")
library("cowplot")
library("ggthemes")
library("MASS")
library("rstan")
library("ggdag")
theme_set(theme_few())
```

# Confounders Analysis

Currently the following confounders are implemented:

* No confounder
* Collider
* Pipe

## Simulate Data

Generate data and plot DAG for a given confounder.

```{r plot_dag_no_confounders}
plot_dag = function(dag, title_str) {
  expand_plot = function(expand_x = expand_scale(c(.1, .1)),
                        expand_y = expand_scale(c(.1, .1))) {
  list(
      ggplot2::scale_x_continuous(expand = expand_x),
      ggplot2::scale_y_continuous(expand = expand_y)
    )
  }
  ggdag(dag, layout = "circle") + 
    geom_dag_point() +
    geom_dag_text() +
    theme_dag_blank() +
    expand_plot(expand_x = expand_scale(c(.4, .4)), 
                expand_y = expand_scale(c(.4, .4))) +
    ggtitle(title_str) +
    theme(plot.title = element_text(hjust = 0.5))
}

# no confounders
set.seed(0xdada)
tb_sim = tibble(
  X = c(rep(1,500), rep(2,500)),
  Y2 = X + rnorm(1000),
  Y1 = X + rnorm(1000)
)
dag = dagify(Y1 ~ X, Y2 ~ X)
plot_dag(dag, "No Confounders")
ggsave(filename = paste0("dag_no_confounder.pdf"), width = 3, height = 2.5)

# pipe
set.seed(0xdada)
tb_sim_pipe = tibble(
  X = c(rep(1,500), rep(2,500)),
  Y2 = X + rnorm(1000),
  Y1 = Y2 + rnorm(1000)
)
dag_pipe = dagify(Y2 ~ X, Y1 ~ Y2)
plot_dag(dag_pipe, "Pipe")
ggsave(filename = paste0("dag_pipe.pdf"), width = 3, height = 2.5)

# collider
set.seed(0xdada)
tb_sim_collider = tibble(
  X = c(rep(1,500), rep(2,500)),
  Y2 = X + rnorm(1000),
  Y1 = X + rnorm(1000) + if_else(Y2 > 2, tb_sim$Y2, 0)
)
dag_collider = dagify(Y1 ~ X, Y2 ~ X, Y1 ~ Y2)
plot_dag(dag_collider, "Collider")
ggsave(filename = paste0("dag_collider.pdf"), width = 3, height = 2.5)
```

## Prepare Helper Functions

Prepare visualize data function.

```{r visualize_data}
visualize_data = function(tb_sim) {
  tb_long = tb_sim %>% gather(key, value, Y1, Y2)
  p1 = ggplot(tb_long, aes(value, fill = factor(X))) + 
    geom_histogram(bins = 50, alpha= 0.5, position = "identity") +
    facet_wrap(~key, nrow = 2)
  colorscale = scale_fill_gradientn(
    colors = rev(brewer.pal(9, "YlGnBu")), 
    values = c(0, exp(seq(-5, 0, length.out = 100)))
  )
  p2 = ggplot(tb_sim, aes(Y1, Y2)) +
    geom_hex(bins = 16) +
    colorscale +
    coord_fixed()
  plot_grid(p1, p2)
}
```

Prepare fit logistic model function.

```{r predictor_model}
writeLines(readLines("multivariate_predictor.stan"))
fit_plot_prediction_model = function(tb_sim) {
  stan_data = list(
    p = nlevels(factor(tb_sim$X)),
    n = nrow(tb_sim),
    y = tb_sim$X-1,
    x = tb_sim %>% dplyr::select(c(Y1, Y2))
  )
  model = stan_model(file = "multivariate_predictor.stan",
                     model_name = "multivariate_predictor_index")
  fit_mcmc = sampling(model, pars = "beta",
                      data = stan_data, iter = 1000, warmup = 500, 
                      chains = 4, cores = 4, seed = 0xdada)
  fit_mcmc
  tb_pred = tidy(fit_mcmc, conf.int = TRUE, conf.level = 0.95)
  tb_pred
  ggplot(tb_pred, aes(estimate, term)) +
    geom_point() +
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme(axis.title.y = element_blank())
}
```

Prepare fit multivariate poisson response model function.

```{r response_model}
writeLines(readLines("multivariate_response.stan"))
fit_plot_response_model = function(tb_sim) {
  stan_data = list(
    d = 2,
    p = nlevels(factor(tb_sim$X)),
    n = nrow(tb_sim),
    y = tb_sim %>% dplyr::select(c(Y1, Y2)),
    x = tb_sim$X
  )
  model = stan_model(file = "multivariate_response.stan",
                     model_name = "multivariate_response_index")
  fit_mcmc = sampling(model, pars = c("beta", "sigma", "Cor"),
                      data = stan_data, iter = 1000, warmup = 500, 
                      chains = 4, cores = 4, seed = 0xdada)
  fit_mcmc
  tb_resp = tidy(fit_mcmc, conf.int = TRUE, conf.level = 0.95)
  ggplot(tb_resp, aes(estimate, term)) +
    geom_point() +
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme(axis.title.y = element_blank())
}
```

## No Confounders

Fit both models and plot results.

```{r analysis_no_confounders}
visualize_data(tb_sim)
plot_grid(
  fit_plot_prediction_model(tb_sim),
  fit_plot_response_model(tb_sim)  
)
```

## Pipe

Fit both models and plot results.

```{r analysis_pipe}
visualize_data(tb_sim_pipe)
plot_grid(
  fit_plot_prediction_model(tb_sim_pipe),
  fit_plot_response_model(tb_sim_pipe)
)
```

## Collider

Fit both models and plot results.

```{r analysis_collider}
visualize_data(tb_sim_collider)
plot_grid(
  fit_plot_prediction_model(tb_sim_collider),
  fit_plot_response_model(tb_sim_collider)
)
```

# Session Info {.unnumbered}

```{r session_info}
sessionInfo()
```
